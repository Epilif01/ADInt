<html>

<head>
    <title>QRCode Context</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"> </script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">QRCode Context</a>
        </div>
    </nav>
    <div class="container mt-3">
        {% if current_user.is_authenticated %}
        <div class="alert alert-info" role="alert">FENIX Authenticated</div>
        {% else %}
        <div class="alert alert-danger" role="alert">NOT FENIX Authenticated</div>
        {% endif %}


        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-info" role="alert">
            {% for message in messages %}
            {{ message }}<br>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        {% if current_user.is_authenticated %}
        <h2>Hi, {{ current_user.username }}!</h2>
        <div class="buttonContainer" display="flex">
            <a class="btn btn-primary" href="{{ url_for('logout') }}">Logout</a>
            <button class="btn btn-primary" id="screenToggle">Messages</button>
            <button class="btn btn-primary" id="screenToggle1" style="display:none;">Main</button>
        </div>
        {% else %}
        <p>
            <a class="btn btn-primary" href="{{ url_for('oauth2_authorize', provider='fenix') }}">Login with FENIX</a>
        </p>
        {% endif %}

        <div id="screenToggle2">
            <h2> QR Code reader</h2>
            <button class="btn btn-primary" id="QRCodeBTN">Read QRCode</button>
            <div class="qrcodereader" style="width: 500px; display:none;" id="reader"></div>


            <div class="info" style="display:none;" id="info">
                <h2>INFO</h2>
                <a class="btn btn-primary" id="info">Info</a>
            </div>
        </div>

        <div class="messagesMenu" id="screenToggle3" style="display:none;">
            <h2>Room: {{Room}}</h2>
            <h2>Users:</h2>
            <button class="btn btn-primary" id="refreshUsers">Refresh</button>
            <ul id="userlist"></ul>
            <div class="ui form">
                <div class="field">
                    <textarea rows="2" placeholder="Type your message..."></textarea>
                </div>
                <button class="ui primary button" type="submit">Send</button>
            </div>
            <h2>Messages:</h2>

        </div>
    </div>


    <script>

        $("#refreshUsers").click(function () {
            $("#userlist").empty();
            $.ajax({
                url: '/api/checked_in/{{Room}}',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var users = JSON.parse(data);
                    for (user in users) {
                        $("#userlist").append("<li>" + user.id + "</li>");
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error: " + error);
                }
            });
        });

        $("#QRCodeBTN").click(function () {
            $(".qrcodereader").toggle();
        });
        function onScanSuccess(decodedText, decodedResult) {
            // Handle on success condition with the decoded text or result.
            console.log(`Scan result: ${decodedText}`, decodedResult);
            //alert(`Scan result: ${decodedText}`, decodedResult);
            $(".info").show();

            $("#info").click(function () {
                $.ajax({
                    url: decodedText,
                    type: "GET",
                    success: function (data) {
                        console.log(data);
                        alert(data);
                        data = JSON.parse(data);
                        if (data.id == "room") {

                        } else if (data.id == "restaurant") {

                        }
                    },
                    failure: function (errMsg) {
                        alert(errMsg);
                    }
                });
            });
        }
        var html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, rememberLastUsedCamera: false });
        html5QrcodeScanner.render(onScanSuccess);

        $("#screenToggle").click(function () {
            $("#screenToggle").toggle();
            $("#screenToggle1").toggle();
            $("#screenToggle2").toggle();
            $("#screenToggle3").toggle();

            $("#refreshUsers").click();

            setTimeout(function () {
                $("#refreshUsers").click();
            }, 5000);
        });
        $("#screenToggle1").click(function () {
            $("#screenToggle").toggle();
            $("#screenToggle1").toggle();
            $("#screenToggle2").toggle();
            $("#screenToggle3").toggle();

            clearTimeout();
        });
    </script>
</body>

</html>