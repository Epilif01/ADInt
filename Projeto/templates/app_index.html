<html>

<head>
    <title>QRCode Context</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"> </script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">QRCode Context</a>
        </div>
    </nav>
    <div class="container mt-3">
        {% if current_user.is_authenticated %}
        <div class="alert alert-info" role="alert">FENIX Authenticated</div>
        {% else %}
        <div class="alert alert-danger" role="alert">NOT FENIX Authenticated</div>
        {% endif %}


        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-info" role="alert">
            {% for message in messages %}
            {{ message }}<br>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        {% if current_user.is_authenticated %}
        <h2>Hi, {{ current_user.username }}!</h2>
        <div class="buttonContainer" display="flex">
            <a class="btn btn-primary" href="{{ url_for('logout') }}">Logout</a>
            <button class="btn btn-primary" id="screenToggle">Messages</button>
            <button class="btn btn-primary" id="screenToggle1" style="display:none;">Main</button>
        </div>
        {% else %}
        <p>
            <a class="btn btn-primary" href="{{ url_for('oauth2_authorize', provider='fenix') }}">Login with FENIX</a>
        </p>
        {% endif %}

        <div id="screenToggle2">
            <h2> QR Code reader</h2>
            <button class="btn btn-primary" id="QRCodeBTN">Read QRCode</button>
            <div class="qrcodereader" style="width: 500px; display:none;" id="reader"></div>


            <div class="info" style="display:none;" id="info">
                <h2>INFO</h2>
                <a class="btn btn-primary" id="info">Info</a>
            </div>
        </div>

        <div class="messagesMenu" id="screenToggle3" style="display:none;">
            <h2>Room: {{Room}}</h2>
            <button class="btn btn-primary" id="checkInButton">Check in</button>
            <button class="btn btn-primary" id="checkOutButton" style="display:none;">Check out</button>
            <!-- <div class="ui dropdown" id="userList">
                <div class="text">Select User</div>
                <i class="dropdown icon"></i>
                <div class="menu">
                </div>
            </div> -->
            <div class="ui form" style="display:none;" id="messageForm">
                <div class="field">
                    <textarea id="message" rows="2" placeholder="Type your message..."></textarea>
                </div>
                <button class="ui primary button" type="submit">Send</button>
            </div>
            <h2>Messages:</h2>
            <button class="btn btn-primary" id="refreshMessages">Refresh</button>
            <ul id="messageList"></ul>

        </div>
    </div>


    <script>

        $("#QRCodeBTN").click(function () {
            $(".qrcodereader").toggle();
        });
        function onScanSuccess(decodedText, decodedResult) {
            // Handle on success condition with the decoded text or result.
            console.log(`Scan result: ${decodedText}`, decodedResult);
            //alert(`Scan result: ${decodedText}`, decodedResult);
            $(".info").show();

            let url = "/api/" + (decodedText[0] == 's' ? decodedText.substring(1) + "/schedule" : decodedText.substring(1) + "/menu")

            $("#info").click(function () {
                $.ajax({
                    url: url,
                    type: "GET",
                    success: function (data) {
                        console.log(data);
                        $("#info").empty();
                        if (decodedText[0] == 's') {
                            for (slot of data) {
                                $("#info").append("<li>" + slot + "</li>");
                            }
                        } else if (decodedText[s] == 'r') {
                            for (item of data) {
                                $("#info").append("<li>" + item + "</li>");
                            }
                        }
                    },
                    failure: function (errMsg) {
                        alert(errMsg);
                    }
                });
            });
        }
        var html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, rememberLastUsedCamera: false });
        html5QrcodeScanner.render(onScanSuccess);

        /* $("#userList").dropdown({
            onShow: function () {
                $("#userList .menu").empty();
                $.ajax({
                    url: '/api/checked_in/{{Room}}',
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        var books = JSON.parse(data);
                        for (book in books) {
                            $("#userList .menu").append("<div class='item' data-value='" + book.user_id + "'>" + book.user_name + "</div>");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("Error: " + error);
                    }
                });
            }, 
            onActionable: function (value, text, $selectedItem) {
                $("#messageForm").show();
                { { destination = value } }
            }
        }); */

        $("#refreshMessages").click(function () {
            $("#messagelist").empty();
            $.ajax({
                url: '/api/messagesreceived/{{current_user.istid}}',
                type: 'GET',
                // dataType: 'json',
                success: function (data) {
                    console.log("{{current_user.id}}");
                    console.log(data);
                    // Handle the successful response and format the messages
                    const messageList = $('#messageList');
                    for (const sender in data) {
                        const message = data[sender];
                        const formattedMessage = `${sender}: ${message}`;
                        messageList.append(`<li>${formattedMessage}</li>`);
                        console.log(formattedMessage);
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error: " + error);
                }
            });
        });

        $("#checkInButton").click(function () {
            $.ajax({
                url: '/api/check_in/{{Room}}/{{current_user.istid}}',
                type: 'POST',
                dataType: 'json',
                success: function (data) {
                    console.log(data);
                    $("#checkInButton").toggle();
                    $("#checkOutButton").toggle();
                },
                error: function (xhr, status, error) {
                    console.log("Error: " + error);
                }
            });
        });

        $("#checkOutButton").click(function () {
            $.ajax({
                url: '/api/check_out/{{current_user.istid}}',
                type: 'POST',
                dataType: 'json',
                success: function (data) {
                    console.log(data);
                    $("#checkInButton").toggle();
                    $("#checkOutButton").toggle();
                },
                error: function (xhr, status, error) {
                    console.log("Error: " + error);
                }
            });
        });

        $("#screenToggle").click(function () {
            $("#screenToggle").toggle();
            $("#screenToggle1").toggle();
            $("#screenToggle2").toggle();
            $("#screenToggle3").toggle();

            setTimeout(function () {
                $("#refreshMessages").click();
            }, 5000);
        });
        $("#screenToggle1").click(function () {
            $("#screenToggle").toggle();
            $("#screenToggle1").toggle();
            $("#screenToggle2").toggle();
            $("#screenToggle3").toggle();

            clearTimeout();
        });
    </script>
</body>

</html>